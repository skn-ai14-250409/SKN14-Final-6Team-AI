# 쿼리 보강 모듈 (B 역할) 구현 상태

## 개요
- **담당자**: B 역할
- **주요 함수**: `enhance_query` 
- **소비 인터페이스**: A→ `query` (라우터에서 받은 원본 쿼리)
- **납품물**: 재작성/슬롯/키워드 결과
- **구현 상태**: ✅ 완료

## 구현 파일
- `query_enhancer.py` - 메인 구현 파일

## 주요 기능

### 1. 쿼리 재작성 ✅
- **목적**: 사용자의 자연어 쿼리를 작업 지향적 문장으로 변환
- **구현 내용**:
  - 질문형 → 요청형 변환 ("상추 있나요?" → "상추 찾아줘")
  - 생략된 주어/목적어 보완
  - 의도 명확화

### 2. 슬롯 추출 ✅  
- **목적**: 구조화된 정보 추출 (소수점 수량 지원)
- **추출 가능한 슬롯**:
  - `quantity`: 원본 수량 (2팩, 1.5kg, 500g 등)
  - `quantity_standard`: 표준 변환 수량 (동치 비교용: 500g→0.5kg)
  - `unit_original`: 원본 단위 (사용자 표시용)
  - `unit_standard`: 표준 단위 (시스템 처리용)
  - `unit_category`: 단위 카테고리 (weight, volume, count)
  - `category`: 상품 카테고리 (채소, 과일, 육류 등) 
  - `price_cap`: 예산 상한선
  - `delivery_window`: 배송창 (내일, 오전 등)
  - `dietary_restrictions`: 식이제한 (비건, 베지테리안 등)
  - `allergens`: 알러지 정보 (견과류, 우유 등)
  - `origin`: 원산지 (국산, 수입산 등)
  - `freshness_level`: 신선도 (신선한, 유기농 등)

### 3. 키워드 생성 ✅
- **목적**: BM25 검색 친화적 키워드 생성
- **기능**: 
  - 재작성된 쿼리에서 명사 추출
  - 슬롯 정보 기반 키워드 확장
  - 카테고리별 관련 키워드 추가
  - 중복 제거 및 길이 필터링 (최대 10개)

### 4. PII 차단기 ✅
- **목적**: 민감정보 마스킹
- **지원 패턴**:
  - 주문번호: `QK-2025-000123` → `[주문번호]`
  - 전화번호: `010-1234-5678` → `[전화번호]` 
  - 이메일: `user@example.com` → `[이메일]`
  - 카드번호: `1234-5678-9012-3456` → `[카드번호]`

### 5. 고급 단위 처리 ✅
- **목적**: 다양한 단위 표현 통일 및 동치 비교
- **소수점 지원**: 0.5kg, 1.8L, 2.5개 등 소수점 수량 인식
- **mL 단위 추가**: ml, mL, ML, 밀리리터 모두 지원
- **동치 변환**: 
  - 중량: 500g ↔ 0.5kg (kg 표준화)
  - 부피: 1500ml ↔ 1.5L (L 표준화)  
  - 개수: 2팩 = 2ea (의미 보존 + ea 표준화)
- **이중 저장**: 원본(사용자용) + 표준(시스템용) 동시 제공

## 입력/출력 인터페이스

### 입력
```python
ChatState(
    query="신선한 상추 2팩 내일까지 받고싶어. 예산은 1만원 이하로"
)
```

### 출력  
```python
{
    "rewrite": {
        "text": "신선한 상추 2팩 내일까지 받고싶어. 예산은 1만원 이하로 주문하고 싶어",
        "keywords": ["신선한", "상추", "팩", "내일", "예산", "만원", "이하", "주문"],
        "original": "신선한 상추 2팩 내일까지 받고싶어. 예산은 1만원 이하로",
        "masked": "신선한 상추 2팩 내일까지 받고싶어. 예산은 1만원 이하로"
    },
    "slots": {
        "quantity": 2,              # 원본 수량
        "quantity_standard": 2,     # 표준 수량 (동치 비교용)
        "unit_original": "팩",      # 원본 단위
        "unit_standard": "ea",      # 표준 단위
        "unit_category": "count",   # 단위 카테고리
        "category": "채소", 
        "price_cap": 10000,
        "delivery_window": "내일",
        "freshness_level": "신선한"
    }
}
```

## 테스트 결과 ✅

### 기능 테스트
1. **기본 상품 주문**: 수량, 카테고리, 예산, 배송창, 신선도 슬롯 추출 성공
2. **PII 포함 쿼리**: 주문번호, 전화번호 마스킹 성공
3. **레시피 관련**: 식이제한 추출 성공
4. **알러지 포함**: 알러지 정보 및 카테고리 추출 성공  
5. **원산지 지정**: 원산지, 카테고리, 수량 추출 성공

### 고급 단위 처리 테스트 ✅
1. **소수점 수량**: 0.5kg, 1.8L, 2.5개 등 정확 추출
2. **mL 단위**: ml, mL, ML, 밀리리터 모두 인식
3. **동치 비교**: 
   - 500g ↔ 0.5kg → 동일 (0.5 kg)
   - 1500mL ↔ 1.5L → 동일 (1.5 L)
   - 2000그램 ↔ 2킬로 → 동일 (2 kg)

### 경계 케이스 테스트
- 빈 쿼리, 단일 단어, 숫자만, 특수문자, 긴 쿼리 모두 안전하게 처리

## 연동 방법

### C 역할(상품검색)과의 연동
- B 역할의 출력 `rewrite.keywords`와 `slots`를 C 역할이 소비
- C 역할은 이 정보를 바탕으로 RAG/Text2SQL 검색 수행

### 사용 예시
```python
from query_enhancer import enhance_query
from graph_interfaces import ChatState

# 상태 생성  
state = ChatState()
state.query = "유기농 토마토 500g 주문하고 싶어요"

# 쿼리 보강
result = enhance_query(state)

# 결과 활용
keywords = result['rewrite']['keywords']              # C 역할에서 검색용
category = result['slots']['category']                # 필터링용
original_qty = result['slots']['quantity']            # 사용자 표시: 500
standard_qty = result['slots']['quantity_standard']   # 시스템 처리: 0.5
original_unit = result['slots']['unit_original']      # 사용자 표시: "g"  
standard_unit = result['slots']['unit_standard']      # 시스템 처리: "kg"

# 동치 비교 활용
# "토마토 500g"과 "토마토 0.5kg"이 같은 상품으로 매칭됨
```

## 향후 개선 사항
1. **LLM 연동**: 규칙 기반 재작성을 LLM 호출로 고도화
2. **형태소 분석**: KoNLPy 등을 활용한 정확한 키워드 추출
3. **의미 분석**: 동의어, 유의어 확장을 통한 키워드 풍부화
4. **학습 기반**: 사용자 피드백을 통한 슬롯 추출 정확도 향상

---
**구현 완료일**: 2025-09-02  
**최종 업데이트**: 2025-09-02 (소수점 지원, mL 단위 추가, 동치 비교 기능 완료)  
**구현자**: B 역할 담당자